<!DOCTYPE html>
<html>
    <head>
        <script type="module">
            import init, { Heightmap, WasmBFS, XY } from "./pkg/day12.js";
            let table = null;
            let start_xy = null;
            let end_xy = null;
            let timer = null;

            const getContent = () => {
                return document.getElementById("input").value;
            }

            const render = (coords, track) => {
                console.log(track);
                if (table !== null) {
                    document.getElementById("output").removeChild(table);
                }
                track = track || [];
                let path_map = {};
                for (let i = 0; i < track.length; i++) {
                    path_map[`${track[i].x}:${track[i].y}`] = true;
                }

                table = document.createElement('table');
                table.style.width = '100%';
                table.style.border = '1px solid black';

                let splitted = getContent()
                    .split('\n')
                    .map((xs) => xs.split(''));

                for (const [y, xs] of splitted.entries()) {
                    let tr = table.insertRow();
                    for (const [x, chr] of xs.entries()) {
                        const td = tr.insertCell();
                        td.onclick = () => {
                            document.getElementById("cell-coord").innerText = `${x}:${y}`;
                        }
                        td.appendChild(document.createTextNode(chr));
                        td.style.border = '1px solid';
                        let coord = `${x}:${y}`;
                        if (path_map[coord]) {
                            td.style.background += 'yellow';
                        } else if (coords[coord]) {
                            td.style.background += 'red';
                        } else {
                            td.style.border += ' black';
                        }
                    }
                }

                document.getElementById("output").appendChild(table);
                document.getElementById("path-length").innerText = track.length;
            }

            const get_coord = (id) => {
                const val = document.getElementById(id).value;
                if (val == '')
                    return;
                let [x, y] = val.split(':');
                return new XY(parseInt(x), parseInt(y));
            };

            (async function run() {
                await init();
                document.getElementById("init-button").onclick = () => {
                    let content = getContent();
                    let heightmap = new Heightmap(content);
                    start_xy = get_coord("start") || heightmap.find_height('S');
                    end_xy = get_coord("end") || heightmap.find_height('E');

                    let coords = {};
                    let addCoord = (xy) => {
                        if (xy === null || xy === undefined) return;
                        let coord = `${xy.x}:${xy.y}`;
                        coords[coord] = true;
                    }

                    render(coords);

                    let bfs = new WasmBFS(start_xy, end_xy, heightmap);
                    document.getElementById("step-button").onclick = () => {
                        let stepCount = parseInt(document.getElementById("step-count").value)
                        let lastCoord = null;
                        for (let i = 0; i < stepCount; i++) {
                            lastCoord = bfs.step();
                            addCoord(lastCoord);
                        }

                        render(coords, bfs.backtrack(lastCoord));
                    }

                    document.getElementById("best-button").onclick = () => {
                        while (true) {
                            let coord = bfs.step();
                            if (coord === null || (coord.x == end_xy.x && coord.y == end_xy.y))
                                break;
                        }

                        render(coords, bfs.backtrack(end_xy));
                    }
                };
            })();
        </script>
    </head>
    <body>
        <div style="position: fixed; top: 0; left: 0; border: 0; margin: 10px; padding: 10px; background-color: beige;">
            <textarea id="input"></textarea><br>
            <div>Start <input id="start"></div>
            <div>End <input id="end"></div>
            <button id="init-button">Init</button><br><br>
            <input type="number" value="1" id="step-count">
            <button id="step-button">Step</button>
            <button id="best-button">Find solution</button><br><br>
            <div>Path length: <span id="path-length">0</span></div>
            <div>Cell coord: <span id="cell-coord"></span></div>
        </div>

        <div id="output" style="margin-top: 150px;"></div>
    </body>
</html>
